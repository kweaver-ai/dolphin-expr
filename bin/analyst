#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
å®éªŒåˆ†æä¸»å…¥å£è„šæœ¬

è¿™æ˜¯æ¨èçš„ç»Ÿä¸€å…¥å£ç‚¹ï¼Œæä¾›æ‰€æœ‰å®éªŒåˆ†æåŠŸèƒ½ï¼š

ä½¿ç”¨æ–¹æ³•:
    # æ€»ä½“åˆ†æï¼ˆé»˜è®¤ï¼‰
    python analyze.py bird_baseline_20250804_105810
    python analyze.py bird_baseline_20250804_105810 --general
    
    # æ™ºèƒ½ä½“æ‰§è¡Œåˆ†æ
    python analyze.py bird_baseline_20250804_105810 --analysis --run run_001 --case 001

æ¶æ„è¯´æ˜:
    - analyze.py: ç»Ÿä¸€å…¥å£å’Œå‘½ä»¤è¡Œè§£æ
    - experiment_coordinator.py: æ ¸å¿ƒåè°ƒé€»è¾‘å’Œæ¨¡å—ç®¡ç†
    - general_reporter.py: æ€»ä½“æŠ¥å‘Šç”Ÿæˆ
    - execution_analyzer.py: æ™ºèƒ½ä½“æ‰§è¡Œåˆ†æ
    - experiment_analyzer.py: æ•°æ®åŠ è½½å™¨ï¼ˆé‡ç”¨ç°æœ‰é€»è¾‘ï¼‰
"""

import sys
import os
from pathlib import Path
# Add analyst directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent / "analyst"))
from experiment_coordinator import ExperimentCoordinator
from simulation_inject import SimulationInjector


def main():
    import argparse
    
    parser = argparse.ArgumentParser(description="å®éªŒåˆ†æä¾¿æ·å…¥å£è„šæœ¬")
    parser.add_argument("experiment_path", help="å®éªŒç›®å½•è·¯å¾„ (experiments/envä¸‹çš„ç›®å½•)")
    
    # åˆ†ææ¨¡å¼é€‰é¡¹
    mode_group = parser.add_mutually_exclusive_group()
    mode_group.add_argument("--general", action="store_true",
                           help="æ‰§è¡Œæ€»ä½“åˆ†ææ¨¡å¼ï¼ˆç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼‰")
    mode_group.add_argument("--analysis", action="store_true",
                           help="æ‰§è¡Œæ™ºèƒ½ä½“æ‰§è¡Œåˆ†ææ¨¡å¼")
    mode_group.add_argument("--cross-run-analysis", action="store_true",
                           help="æ‰§è¡Œè·¨runåˆ†ææ¨¡å¼ï¼Œæ ¹æ®æ­£ç¡®ç‡é˜ˆå€¼ç­›é€‰cases")
    mode_group.add_argument("--sim-inject", action="store_true",
                           help="æ‰§è¡Œæ¨¡æ‹Ÿæ³¨å…¥æ¨¡å¼ï¼Œé€šè¿‡æ³¨å…¥ä¼˜åŒ–åçš„promptæ¥æ”¹è¿›å›°éš¾caseçš„æ‰§è¡Œç»“æœ")

    # æ™ºèƒ½ä½“æ‰§è¡Œåˆ†æå‚æ•°
    parser.add_argument("--run", help="æŒ‡å®šrunåç§°ï¼ˆç”¨äº--analysisæ¨¡å¼ï¼‰")
    parser.add_argument("--case", help="æŒ‡å®šcaseç¼–å·ï¼ˆåœ¨ --analysis æˆ– --cross-run-analysis æ¨¡å¼ä¸‹å‡å¯ç”¨ï¼›æ”¯æŒ case_001ã€001 æˆ– 1ï¼‰")
    parser.add_argument("--summary", action="store_true", help="æ‰§è¡Œsummaryåˆ†ææ¨¡å¼ï¼ˆç”¨äº--analysis --runæ¨¡å¼ï¼‰")
    parser.add_argument("--failed-only", action="store_true", help="ä»…åˆ†æå¤±è´¥çš„casesï¼ˆç”¨äº--analysis --runæ¨¡å¼ï¼‰")
    parser.add_argument("--knows", help="ä¸šåŠ¡çŸ¥è¯†æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç”¨äº--analysisæ¨¡å¼ï¼‰")

    # è·¨runåˆ†æå‚æ•°
    parser.add_argument("--max-accuracy", type=float,
                       help="æœ€é«˜æ­£ç¡®ç‡é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼Œå¦‚30è¡¨ç¤º30%%ï¼‰ï¼Œç­›é€‰æ­£ç¡®ç‡ä½äºæ­¤å€¼çš„casesè¿›è¡Œåˆ†æ")
    parser.add_argument("--report-csv", help="æŒ‡å®šgeneral report CSVæ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè¯»å–æ­£ç¡®ç‡æ•°æ®")

    # æ¨¡æ‹Ÿæ³¨å…¥å‚æ•°
    parser.add_argument("--case_id", help="æŒ‡å®šè¦è¿›è¡Œæ¨¡æ‹Ÿæ³¨å…¥çš„case IDï¼ˆå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™å¤„ç†æ‰€æœ‰ä½å‡†ç¡®ç‡casesï¼‰")
    parser.add_argument("--entrypoint", help="æ›¿æ¢æ‰§è¡Œçš„entrypoint")
    parser.add_argument("--inject-var", default="injects", help="æ³¨å…¥å˜é‡åï¼Œé»˜è®¤ä¸ºinjects")
    parser.add_argument("--sim-timeout", type=int, default=500,
                        help="æ¨¡æ‹Ÿæ³¨å…¥é˜¶æ®µå­è¿›ç¨‹è¶…æ—¶ï¼ˆç§’ï¼‰ã€‚0 è¡¨ç¤ºä¸é™åˆ¶ï¼Œé»˜è®¤ 500 ç§’")
    parser.add_argument("--max-iterations", type=int, default=5,
                        help="æ¯ä¸ªcaseçš„æœ€å¤§æ¨¡æ‹Ÿè¿­ä»£æ¬¡æ•°ï¼Œé»˜è®¤5æ¬¡")
    parser.add_argument("--accuracy-threshold", type=float, default=10.0,
                        help="æ‰¹é‡å¤„ç†æ—¶çš„æ­£ç¡®ç‡é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œä»…å¤„ç†ä½äºæ­¤å€¼çš„casesï¼Œé»˜è®¤10%%")
    parser.add_argument("--top-n", type=int, default=5,
                        help="èšåˆæ³¨å…¥æ—¶é€‰æ‹©å‰Nä¸ªæœ€å—æ¬¢è¿çš„å€™é€‰æ³¨å…¥ï¼Œé»˜è®¤5ä¸ª")

    args = parser.parse_args()
    
    experiment_input = args.experiment_path

    # æ„å»ºå®Œæ•´è·¯å¾„
    if os.path.isabs(experiment_input):
        experiment_path = Path(experiment_input)
    else:
        # ç›¸å¯¹è·¯å¾„ï¼ŒåŸºäºexperiments/envç›®å½•
        script_dir = Path(__file__).parent.parent
        experiment_path = script_dir / "env" / experiment_input

    if not experiment_path.exists():
        print(f"é”™è¯¯: å®éªŒè·¯å¾„ä¸å­˜åœ¨: {experiment_path}")

        # åˆ—å‡ºå¯ç”¨çš„å®éªŒ
        env_dir = Path(__file__).parent.parent / "env"
        if env_dir.exists():
            experiments = [d.name for d in env_dir.iterdir() if d.is_dir()]
            if experiments:
                print(f"\nå¯ç”¨çš„å®éªŒ:")
                for exp in sorted(experiments):
                    print(f"  {exp}")
        return 1

    print(f"å¼€å§‹åˆ†æå®éªŒ: {experiment_path.name}")
    print(f"å®éªŒè·¯å¾„: {experiment_path}")
    print("-" * 60)

    # åˆ›å»ºåè°ƒå™¨
    coordinator = ExperimentCoordinator(experiment_path)

    # æ ¹æ®æ¨¡å¼é€‰æ‹©æ‰§è¡Œè·¯å¾„
    if args.sim_inject:
        # æ¨¡æ‹Ÿæ³¨å…¥æ¨¡å¼ï¼ˆæ™ºèƒ½ä¼˜åŒ–ï¼‰ -> ä½¿ç”¨ç‹¬ç«‹çš„ SimulationInjector å®ç°
        injector = SimulationInjector(
            experiment_path=experiment_path,
            data_loader=coordinator.data_loader,
            cross_run_analysis_callback=coordinator.run_cross_run_analysis,
        )
        if args.case_id:
            # å•ä¸ªcaseå¤„ç†
            print("ğŸš€ å¯åŠ¨æ™ºèƒ½æ¨¡æ‹Ÿæ³¨å…¥æ¨¡å¼ (åŸºäºInjectsOptimizer)")
            success = injector.run_simulation_inject(
                case_id=args.case_id,
                entrypoint=args.entrypoint,
                inject_var=args.inject_var,
                knowledge_path=args.knows,
                max_iterations=args.max_iterations,
                timeout_seconds=args.sim_timeout,
                top_n=args.top_n,
            )
        else:
            # æ‰¹é‡å¤„ç†ä½å‡†ç¡®ç‡çš„cases
            success = injector.run_batch_simulation_inject(
                accuracy_threshold=args.accuracy_threshold,
                entrypoint=args.entrypoint,
                inject_var=args.inject_var,
                knowledge_path=args.knows,
                max_iterations=args.max_iterations,
                timeout_seconds=args.sim_timeout,
                top_n=args.top_n,
            )
        return 0 if success else 1
    elif args.cross_run_analysis:
        # è·¨runåˆ†ææ¨¡å¼
        # å½“æŒ‡å®šäº†å…·ä½“çš„caseæ—¶ï¼Œä¸å¼ºåˆ¶è¦æ±‚max_accuracyï¼ˆé»˜è®¤ä½¿ç”¨100ï¼‰
        if not args.max_accuracy and not args.case:
            print("é”™è¯¯: --cross-run-analysisæ¨¡å¼éœ€è¦æŒ‡å®š --max-accuracy å‚æ•°ï¼ˆé™¤éæŒ‡å®šäº† --caseï¼‰")
            print("ä½¿ç”¨æ–¹æ³•: ")
            print("  åˆ†ææ‰€æœ‰ä½äºé˜ˆå€¼çš„cases: python analyze.py <experiment> --cross-run-analysis --max-accuracy <threshold>")
            print("  åˆ†æç‰¹å®šcase: python analyze.py <experiment> --cross-run-analysis --case <case_num>")
            print("ç¤ºä¾‹: python analyze.py watsons_baseline --cross-run-analysis --max-accuracy 30")
            return 1

        # å¦‚æœæŒ‡å®šäº†caseä½†æ²¡æœ‰max_accuracyï¼Œä½¿ç”¨100ä½œä¸ºé»˜è®¤å€¼ï¼ˆåŒ…å«æ‰€æœ‰caseï¼‰
        max_accuracy = args.max_accuracy if args.max_accuracy is not None else (100 if args.case else None)

        success = coordinator.run_cross_run_analysis(
            max_accuracy=max_accuracy,
            report_csv=args.report_csv,
            knowledge_path=args.knows,
            enable_summary=args.summary,
            case=args.case
        )
        return 0 if success else 1
    elif args.analysis or (not args.general and not args.cross_run_analysis and (args.run or args.case or args.summary)):
        # æ£€æŸ¥summaryæ¨¡å¼çš„å‚æ•°è¦æ±‚
        if args.summary:
            if not args.run:
                print("é”™è¯¯: --summaryæ¨¡å¼éœ€è¦æŒ‡å®š --run å‚æ•°")
                print("ä½¿ç”¨æ–¹æ³•: python analyze.py <experiment> --analysis --run <run_name> --summary")
                return 1
            # summaryæ¨¡å¼
            success = coordinator.run_summary_analysis(args.run, knowledge_path=args.knows)
            return 0 if success else 1
        else:
            # æ™ºèƒ½ä½“æ‰§è¡Œåˆ†ææ¨¡å¼
            if not args.run:
                print("é”™è¯¯: --analysisæ¨¡å¼éœ€è¦æŒ‡å®š --run å‚æ•°")
                print("ä½¿ç”¨æ–¹æ³•:")
                print("  åˆ†æå•ä¸ªcase: python analyze.py <experiment> --analysis --run <run_name> --case <case_num>")
                print("  åˆ†ææ‰€æœ‰å¤±è´¥cases: python analyze.py <experiment> --analysis --run <run_name>")
                print("  ä»…åˆ†æå¤±è´¥cases: python analyze.py <experiment> --analysis --run <run_name> --failed-only")
                return 1

            if args.case:
                # åˆ†æå•ä¸ªcase
                success = coordinator.run_execution_analysis(args.run, args.case, knowledge_path=args.knows)
                return 0 if success else 1
            else:
                # æ‰¹é‡åˆ†æcasesï¼ˆé»˜è®¤å¤±è´¥çš„æˆ–å…¨éƒ¨ï¼‰
                success = coordinator.run_batch_execution_analysis(args.run, failed_only=(args.failed_only or True), knowledge_path=args.knows)
                return 0 if success else 1
    else:
        # æ€»ä½“åˆ†ææ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
        success = coordinator.run_general_analysis()
        return 0 if success else 1


if __name__ == "__main__":
    exit(main())
