#!/usr/bin/env python3
"""
Experiment creation script for Dolphin Language.

Usage: ./experiments/bin/create --name experiment_name --dolphins dph_folder
"""

import os
import sys
import argparse
import shutil
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(description='Create a new experiment in the design area')
    parser.add_argument('--name', required=True, help='Name of the experiment')
    parser.add_argument('--dolphins', required=True, help='Path to folder containing .dph files')
    
    args = parser.parse_args()
    
    # Get the root directory (dolphin-language)
    script_path = Path(__file__).resolve()
    root_dir = script_path.parent.parent.parent  # Go up from bin/experiments/ to root
    
    # Validate experiment name doesn't conflict
    design_dir = root_dir / "experiments" / "design"
    experiment_dir = design_dir / args.name
    
    if experiment_dir.exists():
        print(f"Error: Experiment '{args.name}' already exists in experiments/design/", file=sys.stderr)
        sys.exit(1)
    
    # Validate dolphins folder exists and contains .dph files
    dolphins_path = Path(args.dolphins)
    if not dolphins_path.exists():
        print(f"Error: Dolphins folder '{args.dolphins}' does not exist", file=sys.stderr)
        sys.exit(1)
    
    if not dolphins_path.is_dir():
        print(f"Error: '{args.dolphins}' is not a directory", file=sys.stderr)
        sys.exit(1)
    
    # Check if folder contains at least one .dph file
    dph_files = list(dolphins_path.glob("*.dph"))
    if not dph_files:
        print(f"Error: Dolphins folder '{args.dolphins}' does not contain any .dph files", file=sys.stderr)
        sys.exit(1)
    
    # Create experiment directory
    experiment_dir.mkdir(parents=True, exist_ok=True)
    
    try:
        # Copy spec.txt from prototype
        prototype_spec = root_dir / "experiments" / "prototype" / "spec.txt"
        if prototype_spec.exists():
            shutil.copy2(prototype_spec, experiment_dir / "spec.txt")
        else:
            print(f"Warning: Prototype spec.txt not found at {prototype_spec}")
            # Create a default spec.txt
            with open(experiment_dir / "spec.txt", "w") as f:
                f.write('entrypoints: ["main.dph"]\nconfigs:\n  - vm.host: localhost\n    fast: true\nnum_samples: 1\nsample_method: SEQ\n')
        
        # Copy config directory
        config_source = root_dir / "config"
        config_dest = experiment_dir / "config"
        if config_source.exists():
            shutil.copytree(config_source, config_dest)
        else:
            print(f"Warning: Config directory not found at {config_source}")
            config_dest.mkdir()
        
        # Copy dolphins directory
        dolphins_dest = experiment_dir / "dolphins"
        shutil.copytree(dolphins_path, dolphins_dest)
        
        # Create empty runs directory
        runs_dir = experiment_dir / "runs"
        runs_dir.mkdir()
        
        print(f"Successfully created experiment '{args.name}' in experiments/design/")
        print(f"Structure created:")
        print(f"  experiments/design/{args.name}/")
        print(f"    ├── spec.txt")
        print(f"    ├── config/")
        print(f"    ├── dolphins/ ({len(dph_files)} .dph files)")
        print(f"    └── runs/")
        
    except Exception as e:
        # Clean up on error
        if experiment_dir.exists():
            shutil.rmtree(experiment_dir)
        print(f"Error creating experiment: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
